<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>The Tutorial and API Reference of VEDA: Getting Started with VEDA</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">The Tutorial and API Reference of VEDA
   &#160;<span id="projectnumber">2.10.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_GettingStarted.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Getting Started with VEDA </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>VEDA (VE Driver API) and VERA (VE Runtime API) are a CUDA Driver and Runtime API-like APIs for hybrid programming. It is based on AVEO. Most of the functionality is identical to the CUDA Driver API and CUDA Runtime API.</p>
<h3>Introduction</h3>
<p>VEDA is a parallel computing platform and hybrid programming model. It enables Vector engine (VE) for general purpose computing in a simple and elegant manner. VEDA API's are inspired by the widely used CUDA Driver API. It builds upon AVEO and enables easy porting of existing CUDA (and other hybrid) applications to VE. VEDA uses CUDA's design principles and maps these onto the execution model of AVEO.</p>
<p>Using VEDA, a programmer can execute code on VE and can control the execution from VH main program.</p>
<h3>Installation</h3>
<h4>Prerequisite</h4>
<p>VEDA API are build upon AVEO, Hence as a prerequisite first please install AVEO. <br/>
 For veda program execution, veoffload-aveorun package is required. <br/>
 For veda program development, veoffload-aveo and veoffload-aveo-devel packages are required. <br/>
 For installation of aveo packages refer link <a href="https://www.hpc.nec/documents/veos/en/aveo/md_GettingStarted.html">https://www.hpc.nec/documents/veos/en/aveo/md_GettingStarted.html</a></p>
<h4>Installing package</h4>
<p>To run and develop programs, please install veoffload-veda and the runtime package of the compiler (2.2.2 or later).</p>
<p>To install the packages to run and develop programs by yum, execute the following command as root:</p>
<div class="fragment"><div class="line"><span class="preprocessor"># yum install veoffload-veda</span></div>
</div><!-- fragment --><h3>Hello World</h3>
<p>First, let's try a "Hello, World!" program on VE.</p>
<h4>The Required Number of HugePages for VEDA</h4>
<p>VEDA requires HugePages for data transfer. The required number of HugePages 32 per VEDA thread context.</p>
<h4>VE Code</h4>
<p>Code to run on VE is shown below. Standard C functions are available, hence, you can use printf(3).</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="keywordtype">void</span> hello_world(<span class="keywordtype">void</span>) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Hello World!\n&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Save the above code as <a href="examples_2VE_2libvehello_8vc-example.html">libvehello.vc</a>.</p>
<p>A function on VE called via VEDA needs to return a 64-bit unsigned integer. A function on VE called via VEDA can have arguments as mentioned later.</p>
<h4>Compile VE Code</h4>
<p>VEDA supports a function in a shared library.</p>
<p>To execute a function on VE using VEDA, compile and link a source file into a binary for VE.</p>
<p>To build a shared library with the functions for dynamic loading, execute as follows: </p>
<div class="fragment"><div class="line">/opt/nec/ve/bin/ncc -x c -fpic -I/opt/nec/ve/share/veda/include -o libvehello.o -c libvehello.vc</div>
<div class="line">/opt/nec/ve/bin/ncc -shared -o libvehello.vso libvehello.o</div>
</div><!-- fragment --><h4>VH Main Program</h4>
<p>Main routine on VH side to run VE program is shown here.</p>
<p>A program using VEDA needs to include "veda.h" and "vera.h" for VERA. In the header, the prototypes of functions and constants for VEDA and VERA API are defined.</p>
<p>The example VH program to call a VE function in a dynamic library with VEDA: </p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;veda.h&gt;</span></div>
<div class="line"></div>
<div class="line">  1 <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv) {</div>
<div class="line">  2         printf(<span class="stringliteral">&quot;Hello World from Host!\n&quot;</span>);</div>
<div class="line">  3</div>
<div class="line">  4         <a class="code" href="group__vedaapi.html#ga66b3e0f5c2b9a4cfbab02b7f29601c83" title="Initialize the VEDA driver API library. ">vedaInit</a>(0);</div>
<div class="line">  5</div>
<div class="line">  6         VEDAcontext ctx;</div>
<div class="line">  7         <a class="code" href="group__vedaapi.html#gabc52c38c3e52c8803dbb7c7abf5ec514" title="Retain the primary Context on the VEDA device. ">vedaDevicePrimaryCtxRetain</a>(&amp;ctx, 0);</div>
<div class="line">  8         <a class="code" href="group__vedaapi.html#gabc83c44b24c83caba0c95cca93774411" title="Pushes a context on the current CPU thread. ">vedaCtxPushCurrent</a>(ctx);</div>
<div class="line">  9</div>
<div class="line"> 10         VEDAmodule mod;</div>
<div class="line"> 11         <a class="code" href="group__vedaapi.html#gadf3a93ed7158573890797e04eabb0f63" title="To load the VE device code into the VE memory. ">vedaModuleLoad</a>(&amp;mod, <span class="stringliteral">&quot;libvehello.vso&quot;</span>);</div>
<div class="line"> 12</div>
<div class="line"> 13         VEDAfunction func;</div>
<div class="line"> 14         <a class="code" href="group__vedaapi.html#gac74c217e4f29a0f72951cd580cde5153" title="Return the VE address of the VEDA device function located in VEDA module. ">vedaModuleGetFunction</a>(&amp;func, mod, <span class="stringliteral">&quot;hello_world&quot;</span>);</div>
<div class="line"> 15</div>
<div class="line"> 16         VEDAargs args;</div>
<div class="line"> 17         <a class="code" href="group__vedaapi.html#gadd867b48f0da607857be204a6da1e92d" title="Instantiate the VEDA function argument handler. ">vedaArgsCreate</a>(&amp;args);</div>
<div class="line"> 18         <a class="code" href="group__vedaapi.html#ga59b370b3e21e1695c5b3faab342c64ef" title="Enqueues a VEDA device function f on the VEDA device with flexibility. ">vedaLaunchKernelEx</a>(func, 0, args, 1);</div>
<div class="line"> 19</div>
<div class="line"> 20         <a class="code" href="group__vedaapi.html#ga85da2bda2bd16ca7365319f0c9a22f99" title="Block for a context&#39;s tasks to complete. ">vedaCtxSynchronize</a>();</div>
<div class="line"> 21         <a class="code" href="group__vedaapi.html#gaed05e2af5385b68c5705939afeabc190" title="Releases the VEDA driver API library gracefully. ">vedaExit</a>();</div>
<div class="line"> 22</div>
<div class="line"> 23         <span class="keywordflow">return</span> 0;</div>
<div class="line"> 24 }</div>
</div><!-- fragment --><p> Save the above code as <a href="examples_2VH_2hello_8c-example.html">hello.c</a></p>
<ol type="1">
<li>At line #4 <a class="el" href="group__vedaapi.html#ga66b3e0f5c2b9a4cfbab02b7f29601c83" title="Initialize the VEDA driver API library. ">vedaInit()</a> is called to initialized VE devices, the initialized VE devices may be termed as VEDA device.</li>
<li>At the line#6-8 VE process is created on the VEDA device and the handle to the VE process is returned to the VH process. The returned handle to the VE process is termed as the VEDA context in the VEDA hybrid program. <a class="el" href="group__vedaapi.html#gabc52c38c3e52c8803dbb7c7abf5ec514" title="Retain the primary Context on the VEDA device. ">vedaDevicePrimaryCtxRetain()</a> retain the primary Context on the VEDA device and <a class="el" href="group__vedaapi.html#gabc83c44b24c83caba0c95cca93774411" title="Pushes a context on the current CPU thread. ">vedaCtxPushCurrent()</a> pushes a context on the current CPU thread.</li>
<li>Internally VEDA context instantiate the VE threads on the VE device to execute the VE functions. These VE threads are termed as VEDA Streaming Multiprocessor(SM) throughout this mechanism.</li>
<li>At the line #11 VE compiled device code(libvehello.vc) is loaded into the VE memory. <a class="el" href="group__vedaapi.html#gadf3a93ed7158573890797e04eabb0f63" title="To load the VE device code into the VE memory. ">vedaModuleLoad()</a> loads a VE shared library.</li>
<li>At line#14 VE device address of the VE device function “hello_world” retrieved by calling <a class="el" href="group__vedaapi.html#gac74c217e4f29a0f72951cd580cde5153" title="Return the VE address of the VEDA device function located in VEDA module. ">vedaModuleGetFunction()</a> function. VE device function is termed as VEDA device function in VEDA hybrid program. Although VEDA device function and VEDA kernel function can be used interchangeably and logically both the term refers to the same entity VE function. But VEDA kernel functions are different in terms as they are the preloaded VE device functions at the time of context creation. On the other hand, VEDA device function are loaded by the VH program.</li>
<li>At line#18 By calling <a class="el" href="group__vedaapi.html#ga59b370b3e21e1695c5b3faab342c64ef" title="Enqueues a VEDA device function f on the VEDA device with flexibility. ">vedaLaunchKernelEx()</a>, VEDA hybrid program submits the request for the execution of the VEDA device function to VEDA streaming Multiprocessor(SM). It may be termed as launching of the VEDA device function. VEDA arguement would be destroyed after VEDA device function is called as fourth argument is set to 1.</li>
<li>At line#20 Execution of the VH programs is blocked by calling <a class="el" href="group__vedaapi.html#ga85da2bda2bd16ca7365319f0c9a22f99" title="Block for a context&#39;s tasks to complete. ">vedaCtxSynchronize()</a> since the execution of the “hello_world” program is finished, this is termed as VEDA streaming multiprocessor(SM) synchronization.</li>
<li>At line #21 <a class="el" href="group__vedaapi.html#gaed05e2af5385b68c5705939afeabc190" title="Releases the VEDA driver API library gracefully. ">vedaExit()</a> releases the VEDA driver API library gracefully and perform the proper cleanup of the VEDA driver library.</li>
</ol>
<h4>Compile VH Main Program</h4>
<p>Compile source code on VH side as shown below.</p>
<div class="fragment"><div class="line">$ gcc -o hello hello.c -I/opt/nec/ve/share/veda/include  -L/opt/nec/ve/veos/lib64 \</div>
<div class="line">-rdynamic -Wl,-rpath,/opt/nec/ve/veos/lib64 -lveda</div>
</div><!-- fragment --><p>The headers for VEDA and VERA are installed in /opt/nec/ve/veos/include. libveda and libvera, the shared library of VEDA and VERA, is in /opt/nec/ve/veos/lib64.</p>
<h4>Run a program with VEDA</h4>
<p>Execute the compiled VEDA program.</p>
<div class="fragment"><div class="line">$ VE_LD_LIBRARY_PATH=/opt/nec/ve/veos/lib64 ./hello</div>
<div class="line">Hello, world!</div>
</div><!-- fragment --><h3>Various Arguments for a VE function</h3>
<p>You can pass one or more arguments to a function on VE. To specify arguments, VEDA arguments object is used. A VEDA argument object is created by <a class="el" href="group__vedaapi.html#gadd867b48f0da607857be204a6da1e92d" title="Instantiate the VEDA function argument handler. ">vedaArgsCreate()</a>. When a VEDA argument object is created, the VEDA argument object is empty, without any arguments passed. Even if a VE function has no arguments, a VEDA arguments object is still necessary.</p>
<p>VEDA provides functions to set an argument in various types.</p>
<h4>Basic Types</h4>
<p>To pass an integer value, the following functions are used.</p>
<div class="fragment"><div class="line">VEDAresult <a class="code" href="group__vedaapi.html#ga3e9943f44335a3b26166f369e3bc3d62" title="Initialize the VEDA function arguments for 64 bit integer value. ">vedaArgsSetI64</a> (VEDAargs args, <span class="keyword">const</span> <span class="keywordtype">int</span> idx, <span class="keyword">const</span> int64_t value);</div>
<div class="line">VEDAresult <a class="code" href="group__vedaapi.html#ga4dadbe6019939f4f994d36ba83545de9" title="Initialize the VEDA function arguments for 16 bit unsigned integer value. ">vedaArgsSetU16</a> (VEDAargs args, <span class="keyword">const</span> <span class="keywordtype">int</span> idx, <span class="keyword">const</span> uint16_t value);</div>
<div class="line">VEDAresult <a class="code" href="group__vedaapi.html#gad2c67040b0fba35c4347ea98f2a4ca97" title="Initialize the VEDA function arguments for 32 bit integer value. ">vedaArgsSetI32</a> (VEDAargs args, <span class="keyword">const</span> <span class="keywordtype">int</span> idx, <span class="keyword">const</span> int32_t value);</div>
<div class="line">VEDAresult <a class="code" href="group__vedaapi.html#ga2cbe5b1e776480acd1d856a0778c1abb" title="Initialize the VEDA function arguments for 32 bit unsigned integer value. ">vedaArgsSetU32</a> (VEDAargs args, <span class="keyword">const</span> <span class="keywordtype">int</span> idx, <span class="keyword">const</span> uint32_t value);</div>
<div class="line">VEDAresult <a class="code" href="group__vedaapi.html#ga96191564f0c1754415d07ac34c0b3dd4" title="Initialize the VEDA function arguments for 16 bit integer value. ">vedaArgsSetI16</a> (VEDAargs args, <span class="keyword">const</span> <span class="keywordtype">int</span> idx, <span class="keyword">const</span> int16_t value);</div>
<div class="line">VEDAresult <a class="code" href="group__vedaapi.html#ga4dadbe6019939f4f994d36ba83545de9" title="Initialize the VEDA function arguments for 16 bit unsigned integer value. ">vedaArgsSetU16</a> (VEDAargs args, <span class="keyword">const</span> <span class="keywordtype">int</span> idx, <span class="keyword">const</span> int16_t value);</div>
<div class="line">VEDAresult <a class="code" href="group__vedaapi.html#ga1de67a7596f99bc5e43be941036c16a4" title="Initialize the VEDA function arguments for 8 bit unsigned integer value. ">vedaArgsSetU8</a> (VEDAargs args, <span class="keyword">const</span> <span class="keywordtype">int</span> idx, <span class="keyword">const</span> uint8_t value);</div>
<div class="line">VEDAresult <a class="code" href="group__vedaapi.html#ga50d7906bb5030df85264e65f13d9c570" title="Initialize the VEDA function arguments for 8 bit integer value. ">vedaArgsSetI8</a> (VEDAargs args, <span class="keyword">const</span> <span class="keywordtype">int</span> idx, <span class="keyword">const</span> int8_t value);</div>
</div><!-- fragment --><p>You can pass also a floating point number argument.</p>
<div class="fragment"><div class="line">VEDAresult <a class="code" href="group__vedaapi.html#gaaa062e7646e7c824a488d409fa31605a" title="Initialize the VEDA function arguments for single precision floating point value. ...">vedaArgsSetF32</a> (VEDAargs args, <span class="keyword">const</span> <span class="keywordtype">int</span> idx, <span class="keyword">const</span> <span class="keywordtype">float</span> value);</div>
<div class="line">VEDAresult <a class="code" href="group__vedaapi.html#ga2cb9dc3cf4ddf9eee9c1a5980f012b9a" title="Initialize the VEDA function arguments for double precision floating point value. ...">vedaArgsSetF64</a> (VEDAargs args, <span class="keyword">const</span> <span class="keywordtype">int</span> idx, <span class="keyword">const</span> <span class="keywordtype">double</span> value);</div>
</div><!-- fragment --><p> For instance: suppose that veda device is initialized and func(int, double) is defined in a VE library whose handle is func1. </p>
<div class="fragment"><div class="line">VEDAargs args;</div>
<div class="line"><a class="code" href="group__vedaapi.html#gadd867b48f0da607857be204a6da1e92d" title="Instantiate the VEDA function argument handler. ">vedaArgsCreate</a>(&amp;args);</div>
<div class="line"><a class="code" href="group__vedaapi.html#gad2c67040b0fba35c4347ea98f2a4ca97" title="Initialize the VEDA function arguments for 32 bit integer value. ">vedaArgsSetI32</a>(args, 0, 1);</div>
<div class="line"><a class="code" href="group__vedaapi.html#ga2cb9dc3cf4ddf9eee9c1a5980f012b9a" title="Initialize the VEDA function arguments for double precision floating point value. ...">vedaArgsSetF64</a>(args, 1, 2.0);</div>
<div class="line">VEDAmodule mod;</div>
<div class="line"><a class="code" href="group__vedaapi.html#gadf3a93ed7158573890797e04eabb0f63" title="To load the VE device code into the VE memory. ">vedaModuleLoad</a>(&amp;mod, <span class="stringliteral">&quot;libvehello.vso&quot;</span>));</div>
<div class="line">VEDAfunction func1;</div>
<div class="line"><a class="code" href="group__vedaapi.html#gac74c217e4f29a0f72951cd580cde5153" title="Return the VE address of the VEDA device function located in VEDA module. ">vedaModuleGetFunction</a>(&amp;func1, mod, <span class="stringliteral">&quot;func&quot;</span>);</div>
<div class="line"><a class="code" href="group__vedaapi.html#gac14120325e7c5cf26abfccac20367522" title="Enqueues a VEDA device function f on the VEDA device. ">vedaLaunchKernel</a>(func1, 0, args);</div>
</div><!-- fragment --><p>In this case, func(1, 2.0) is called on VE.</p>
<h4>Stack Arguments</h4>
<p>Non basic typed arguments and arguments by reference are put on a stack. VEDA supports an argument on a stack.</p>
<p>To set a stack argument to a VEDA arguments object, call <a class="el" href="group__vedaapi.html#gadadaf124d4b6af7a44b96d232a689c9f" title="Initialize the VEDA function arguments to the buffer on stack. ">vedaArgsSetStack()</a>. </p>
<div class="fragment"><div class="line">VEDAresult <a class="code" href="group__vedaapi.html#gadadaf124d4b6af7a44b96d232a689c9f" title="Initialize the VEDA function arguments to the buffer on stack. ">vedaArgsSetStack</a> (VEDAargs args, <span class="keyword">const</span> <span class="keywordtype">int</span> idx, <span class="keywordtype">void</span>* ptr, </div>
<div class="line">                        VEDAargs_intent intent, <span class="keyword">const</span> <span class="keywordtype">size_t</span> size);</div>
</div><!-- fragment --><p> The fourth argument specifies the argument is for input and/or output.</p>
<ul>
<li>VEDA_ARGS_INTENT_IN: the argument is for input; data is copied into a VE stack on call.</li>
<li>VEDA_ARGS_INTENT_OUT: the argument is for output; a VE stack area is allocated without copy-in and data is copied out to VH memory on completion.</li>
<li>VEDA_ARGS_INTENT_INOUT: the argument is for both input and output; data is copied into and out from a VE stack area.</li>
</ul>
<h3>How to call the function written by Fortran</h3>
<h4>VE Code (Fortran)</h4>
<p>Code written by Fortran to run on VE is shown below.</p>
<div class="fragment"><div class="line">SUBROUTINE SUB1(x, ret)</div>
<div class="line">  implicit none</div>
<div class="line">  INTEGER, INTENT(IN) :: x</div>
<div class="line">  INTEGER, INTENT(OUT) :: ret</div>
<div class="line">  ret = x + 1</div>
<div class="line">END SUBROUTINE SUB1</div>
</div><!-- fragment --><p> Save the above code as <a href="examples_2VE_2libvefortran_8vf90-example.html">libvefortran.vf90</a>.</p>
<h4>Compile VE Code (Fortran)</h4>
<p>To build a shared library with the functions for dynamic loading, execute as follows: </p>
<div class="fragment"><div class="line">$/opt/nec/ve/bin/nfort -x f95 -I/opt/nec/ve/share/veda/include -c -o libvefortran.o libvefortran.vf90</div>
<div class="line">$/opt/nec/ve/bin/nfort  -shared -fpic -o libvefortran.vso libvefortran.o</div>
</div><!-- fragment --><h4>VH Main Program (Fortran)</h4>
<p>Main routine on VH side to run VE program written by Fortran is shown here.</p>
<p>The example VH program to call a VE Fortran function in a dynamically linked executable: </p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;veda.h&gt;</span></div>
<div class="line"></div>
<div class="line">  1 #define VEDA(err) check(err, __FILE__, __LINE__)</div>
<div class="line">  2</div>
<div class="line">  3 <span class="keywordtype">void</span> check(VEDAresult err, const <span class="keywordtype">char</span>* file, const <span class="keywordtype">int</span> line) {</div>
<div class="line">  4         <span class="keywordflow">if</span>(err != VEDA_SUCCESS) {</div>
<div class="line">  5                 <span class="keyword">const</span> <span class="keywordtype">char</span> *name, *str;</div>
<div class="line">  6                 vedaGetErrorName        (err, &amp;name);</div>
<div class="line">  7                 vedaGetErrorString      (err, &amp;str);</div>
<div class="line">  8                 printf(<span class="stringliteral">&quot;%s: %s @ %s:%i\n&quot;</span>, name, str, file, line);</div>
<div class="line">  9                 exit(1);</div>
<div class="line"> 10         }</div>
<div class="line"> 11 }</div>
<div class="line"> 12</div>
<div class="line"> 13 <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv) {</div>
<div class="line"> 14         printf(<span class="stringliteral">&quot;Hello World from Host!\n&quot;</span>);</div>
<div class="line"> 15</div>
<div class="line"> 16         VEDA(<a class="code" href="group__vedaapi.html#ga66b3e0f5c2b9a4cfbab02b7f29601c83" title="Initialize the VEDA driver API library. ">vedaInit</a>(0));</div>
<div class="line"> 17</div>
<div class="line"> 18         VEDAcontext ctx;</div>
<div class="line"> 19         VEDA(<a class="code" href="group__vedaapi.html#gabc52c38c3e52c8803dbb7c7abf5ec514" title="Retain the primary Context on the VEDA device. ">vedaDevicePrimaryCtxRetain</a>(&amp;ctx, 0));</div>
<div class="line"> 20         VEDA(<a class="code" href="group__vedaapi.html#gabc83c44b24c83caba0c95cca93774411" title="Pushes a context on the current CPU thread. ">vedaCtxPushCurrent</a>(ctx));</div>
<div class="line"> 21</div>
<div class="line"> 22         VEDAmodule mod;</div>
<div class="line"> 23         VEDA(<a class="code" href="group__vedaapi.html#gadf3a93ed7158573890797e04eabb0f63" title="To load the VE device code into the VE memory. ">vedaModuleLoad</a>(&amp;mod, <span class="stringliteral">&quot;libvefortran.vso&quot;</span>));</div>
<div class="line"> 24</div>
<div class="line"> 25         VEDAfunction func;</div>
<div class="line"> 26         VEDA(<a class="code" href="group__vedaapi.html#gac74c217e4f29a0f72951cd580cde5153" title="Return the VE address of the VEDA device function located in VEDA module. ">vedaModuleGetFunction</a>(&amp;func, mod, <span class="stringliteral">&quot;sub1_&quot;</span>));</div>
<div class="line"> 27</div>
<div class="line"> 28         VEDAargs args;</div>
<div class="line"> 29         VEDA(<a class="code" href="group__vedaapi.html#gadd867b48f0da607857be204a6da1e92d" title="Instantiate the VEDA function argument handler. ">vedaArgsCreate</a>(&amp;args));</div>
<div class="line"> 30         <span class="keywordtype">size_t</span> x = 42;</div>
<div class="line"> 31         <span class="keywordtype">size_t</span> y = 1;</div>
<div class="line"> 32         VEDA(<a class="code" href="group__vedaapi.html#gadadaf124d4b6af7a44b96d232a689c9f" title="Initialize the VEDA function arguments to the buffer on stack. ">vedaArgsSetStack</a>(args, 0, &amp;x, VEDA_ARGS_INTENT_IN, <span class="keyword">sizeof</span>(x)));</div>
<div class="line"> 33         VEDA(<a class="code" href="group__vedaapi.html#gadadaf124d4b6af7a44b96d232a689c9f" title="Initialize the VEDA function arguments to the buffer on stack. ">vedaArgsSetStack</a>(args, 1, &amp;y, VEDA_ARGS_INTENT_OUT, <span class="keyword">sizeof</span>(y)));</div>
<div class="line"> 34         VEDA(<a class="code" href="group__vedaapi.html#gac14120325e7c5cf26abfccac20367522" title="Enqueues a VEDA device function f on the VEDA device. ">vedaLaunchKernel</a>(func, 0, args));</div>
<div class="line"> 35         VEDA(<a class="code" href="group__vedaapi.html#ga85da2bda2bd16ca7365319f0c9a22f99" title="Block for a context&#39;s tasks to complete. ">vedaCtxSynchronize</a>());</div>
<div class="line"> 36         printf(<span class="stringliteral">&quot;SUB1 return %lu\n&quot;</span>,y);</div>
<div class="line"> 37         VEDA(<a class="code" href="group__vedaapi.html#gaed05e2af5385b68c5705939afeabc190" title="Releases the VEDA driver API library gracefully. ">vedaExit</a>());</div>
<div class="line"> 38</div>
<div class="line"> 39         <span class="keywordflow">return</span> 0;</div>
<div class="line"> 40 }</div>
</div><!-- fragment --><p> Save the above code as <a href="examples_2VH_2fortran_8c-example.html">fortran.c</a>.</p>
<ol type="1">
<li>At line #16 <a class="el" href="group__vedaapi.html#ga66b3e0f5c2b9a4cfbab02b7f29601c83" title="Initialize the VEDA driver API library. ">vedaInit()</a> is called to initialized VE devices, the initialized VE devices may be termed as VEDA device.</li>
<li>At the line#18-20 VE process is created on the VEDA device and the handle to the VE process is returned to the VH process. The returned handle to the VE process is termed as the VEDA context in the VEDA hybrid program. <a class="el" href="group__vedaapi.html#gabc52c38c3e52c8803dbb7c7abf5ec514" title="Retain the primary Context on the VEDA device. ">vedaDevicePrimaryCtxRetain()</a> retain the primary Context on the VEDA device and <a class="el" href="group__vedaapi.html#gabc83c44b24c83caba0c95cca93774411" title="Pushes a context on the current CPU thread. ">vedaCtxPushCurrent()</a> pushes a context on the current CPU thread.</li>
<li>Internally VEDA context instantiate the VE threads on the VE device to execute the VE functions. These VE threads are termed as VEDA Streaming Multiprocessor(SM) throughout this mechanism.</li>
<li>At the line #23 VE compiled device code(libvefortran.vf90) is loaded into the VE memory. <a class="el" href="group__vedaapi.html#gadf3a93ed7158573890797e04eabb0f63" title="To load the VE device code into the VE memory. ">vedaModuleLoad()</a> loads a VE shared library.</li>
<li>At line#26 VE device address of the VE device function “sub1_” retrieved by calling <a class="el" href="group__vedaapi.html#gac74c217e4f29a0f72951cd580cde5153" title="Return the VE address of the VEDA device function located in VEDA module. ">vedaModuleGetFunction()</a> function. VE device function is termed as VEDA device function in VEDA hybrid program. Although VEDA device function and VEDA kernel function can be used interchangeably and logically both the term refers to the same entity VE function. But VEDA kernel functions are different in terms as they are the preloaded VE device functions at the time of context creation. On the other hand, VEDA device function are loaded by the VH program.</li>
<li>At line#29 Instantiate the VEDA function argument handler by calling <a class="el" href="group__vedaapi.html#gadd867b48f0da607857be204a6da1e92d" title="Instantiate the VEDA function argument handler. ">vedaArgsCreate()</a>.</li>
<li>At line#32 <a class="el" href="group__vedaapi.html#gadadaf124d4b6af7a44b96d232a689c9f" title="Initialize the VEDA function arguments to the buffer on stack. ">vedaArgsSetStack()</a> initialize the VEDA function argument to point the buffer on stack. Where x is treated as the Input buffer to the VEDA device function.</li>
<li>At line#33 <a class="el" href="group__vedaapi.html#gadadaf124d4b6af7a44b96d232a689c9f" title="Initialize the VEDA function arguments to the buffer on stack. ">vedaArgsSetStack()</a> initialize the VEDA function argument to point the buffer on stack. Where y is treated as the Output buffer, some output is expected.</li>
<li>At line#34 By calling <a class="el" href="group__vedaapi.html#gac14120325e7c5cf26abfccac20367522" title="Enqueues a VEDA device function f on the VEDA device. ">vedaLaunchKernel()</a>, VEDA hybrid program submits the request for the execution of the VEDA device function to VEDA streaming Multiprocessor(SM). It may be termed as launching of the VEDA device function.</li>
<li>At line#35 Execution of the VH programs is blocked by calling <a class="el" href="group__vedaapi.html#ga85da2bda2bd16ca7365319f0c9a22f99" title="Block for a context&#39;s tasks to complete. ">vedaCtxSynchronize()</a> since the execution of the “sub1_” program is finished, this is termed as VEDA streaming multiprocessor(SM) synchronization.</li>
<li>At line #37 <a class="el" href="group__vedaapi.html#gaed05e2af5385b68c5705939afeabc190" title="Releases the VEDA driver API library gracefully. ">vedaExit()</a> releases the VEDA driver API library gracefully and perform the proper clean-up of the VEDA driver library.</li>
</ol>
<p>For passing arguments to VE Fortran function, please use <a class="el" href="group__vedaapi.html#gadadaf124d4b6af7a44b96d232a689c9f" title="Initialize the VEDA function arguments to the buffer on stack. ">vedaArgsSetStack()</a> to pass arguments as stack arguments. However, for passing arguments to arguments with VALUE attribute in Fortran function, please pass arguments by value in the same way as VE C function.</p>
<p>When you want to load VE Fortran function by <a class="el" href="group__vedaapi.html#gac74c217e4f29a0f72951cd580cde5153" title="Return the VE address of the VEDA device function located in VEDA module. ">vedaModuleGetFunction()</a> with the name of a Fortran function, please change the name of the Fortran function to lowercase, and add "_" at the end of the function name.</p>
<p>Taking libvefortran.vf90 and fortran.c as an example, pass "sub1_" as an argument to <a class="el" href="group__vedaapi.html#gac74c217e4f29a0f72951cd580cde5153" title="Return the VE address of the VEDA device function located in VEDA module. ">vedaModuleGetFunction()</a> in fortran.c when calling the Fortran function named "SUB1" in libvefortran.f90.</p>
<p>The method of compiling and running VH main program are same as C program.</p>
<h4>Compile VH Main Program (Fortran)</h4>
<p>Compile source code on VH side as shown below. This is the same as the compilation method described above.</p>
<div class="fragment"><div class="line">$ gcc -o fortran fortran.c -I/opt/nec/ve/share/veda/include  -L/opt/nec/ve/veos/lib64 \</div>
<div class="line">-rdynamic -Wl,-rpath,/opt/nec/ve/veos/lib64 -lveda</div>
</div><!-- fragment --> <h4>Run a program with VEDA</h4>
<p>Execute the compiled VEDA program. This is also the same as the execution method described above.</p>
<div class="fragment"><div class="line">$ VE_LD_LIBRARY_PATH=/opt/nec/ve/veos/lib64 ./fortran</div>
<div class="line">SUB1 <span class="keywordflow">return</span> 43</div>
</div><!-- fragment --><h3>How to parallelize code using OpenMP</h3>
<h4>VE code using OpenMP in C</h4>
<p>The following is an example of VE code using OpenMP written in C.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="keywordtype">int</span> omp_hello(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> tid, nthreads = 0;</div>
<div class="line"><span class="preprocessor">#pragma omp parallel private(nthreads, tid)</span></div>
<div class="line"><span class="preprocessor"></span>  {</div>
<div class="line">    tid = omp_get_thread_num();</div>
<div class="line">    printf(<span class="stringliteral">&quot;Hello, World! from thread = %d\n&quot;</span>, tid);</div>
<div class="line">    <span class="keywordflow">if</span> (tid == 0)</div>
<div class="line">    {</div>
<div class="line">      nthreads = omp_get_num_threads();</div>
<div class="line">      printf(<span class="stringliteral">&quot;Number of threads = %d\n&quot;</span>, nthreads);</div>
<div class="line">    }</div>
<div class="line">  }  <span class="comment">/* All threads join master thread and disband */</span></div>
<div class="line">  fflush(stdout);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> Save the above code in <a href="examples_2VE_2libomphello_8vc-example.html">libomphello.vc</a>.</p>
<h4>How to build VE code</h4>
<p>To use OpenMP parallelization, specify -fopenmp at compilation and linking.</p>
<p>Here is an example of building VE code written in C.</p>
<p>To build a shared library, execute as follows: </p>
<div class="fragment"><div class="line">$/opt/nec/ve/bin/ncc -x c -fpic -I/opt/nec/ve/share/veda/include -o libomphello.o -c libomphello.vc -fopenmp</div>
<div class="line">$/opt/nec/ve/bin/ncc -shared -o libomphello.vso libomphello.o</div>
</div><!-- fragment --><h5>Compile VH Main Program (Omp)</h5>
<p>Example <a href="examples_2VH_2omphello_8c-example.html">omphello.c</a> which calls the above omp VE code,</p>
<p>Compile source code on VH side as shown below. </p>
<div class="fragment"><div class="line">$ gcc -o omphello omphello.c -I/opt/nec/ve/share/veda/include  -L/opt/nec/ve/veos/lib64 \</div>
<div class="line">-rdynamic -Wl,-rpath,/opt/nec/ve/veos/lib64 -lveda</div>
</div><!-- fragment --><p> Execute the compiled omp VEDA program.</p>
<div class="fragment"><div class="line">$ VE_LD_LIBRARY_PATH=/opt/nec/ve/veos/lib64 ./omphello</div>
<div class="line">Hello World from Host!</div>
<div class="line">Hello, World! from thread = 4</div>
<div class="line">Hello, World! from thread = 2</div>
<div class="line">Hello, World! from thread = 0</div>
<div class="line">Hello, World! from thread = 1</div>
<div class="line">Hello, World! from thread = 5</div>
<div class="line">Hello, World! from thread = 3</div>
<div class="line">Hello, World! from thread = 7</div>
<div class="line">Hello, World! from thread = 6</div>
<div class="line">Number of threads = 8</div>
</div><!-- fragment --><h4>VE code using OpenMP in fortran</h4>
<p>The following shows the example written in Fortran.</p>
<div class="fragment"><div class="line">INTEGER FUNCTION OMP_HELLO()</div>
<div class="line">  INTEGER :: TID = 0</div>
<div class="line">  INTEGER :: NTHREADS = 0</div>
<div class="line">!$OMP PARALLEL PRIVATE(TID, NTHREADS)</div>
<div class="line">  TID = omp_get_thread_num()</div>
<div class="line">  WRITE(*,*) &quot;Hello, World! from thread = &quot;, TID</div>
<div class="line">  IF ( TID == 0 ) THEN</div>
<div class="line">    NTHREADS = omp_get_num_threads()</div>
<div class="line">    OMP_HELLO = NTHREADS</div>
<div class="line">    WRITE(*,*) &quot;Number of threads = &quot;, NTHREADS</div>
<div class="line">  END IF</div>
<div class="line">!$OMP END PARALLEL</div>
<div class="line">END FUNCTION OMP_HELLO</div>
</div><!-- fragment --><p> Save the above code in <a href="examples_2VE_2libompfortran_8vf90-example.html">libompfortran.vf90</a>.</p>
<h4>How to build VE code</h4>
<p>To use OpenMP parallelization, specify -fopenmp at compilation and linking.</p>
<p>Here is an example of building VE code written in Fortran.</p>
<p>To build a shared library, execute as follows: </p>
<div class="fragment"><div class="line">$/opt/nec/ve/bin/nfort -x f95 -fpic -I/opt/nec/ve/share/veda/include -o libompfortran.o -c libompfortran.v95 -fopenmp</div>
<div class="line">$/opt/nec/ve/bin/nfort -shared -o libompfortran.vso libompfortran.o</div>
</div><!-- fragment --><p> To build code written in Fortran, change the compiler to nfort.</p>
<h5>Compile VH Main Program (Omp)</h5>
<p>Example <a href="examples_2VH_2omphellofortran_8c-example.html">omphellofortran.c</a> which calls the above omp VE code,</p>
<p>Compile source code on VH side as shown below. </p>
<div class="fragment"><div class="line">$ gcc -o omphellofortran omphellofortran.c -I/opt/nec/ve/share/veda/include  -L/opt/nec/ve/veos/lib64 \</div>
<div class="line">-rdynamic -Wl,-rpath,/opt/nec/ve/veos/lib64 -lveda</div>
</div><!-- fragment --><p>Execute the compiled omp VEDA program.</p>
<div class="fragment"><div class="line">$ VE_LD_LIBRARY_PATH=/opt/nec/ve/veos/lib64 ./omphellofortran</div>
<div class="line">Hello World from Host!</div>
<div class="line">Hello, World! from thread = 4</div>
<div class="line">Hello, World! from thread = 2</div>
<div class="line">Hello, World! from thread = 0</div>
<div class="line">Hello, World! from thread = 1</div>
<div class="line">Hello, World! from thread = 5</div>
<div class="line">Hello, World! from thread = 3</div>
<div class="line">Hello, World! from thread = 7</div>
<div class="line">Hello, World! from thread = 6</div>
<div class="line">Number of threads = 8</div>
</div><!-- fragment --><h4>NUMA Support</h4>
<p>VEDA supports VE NUMA nodes since v0.10. To enable NUMA on your system you need to execute (set -N ? to specific device index):</p>
<div class="fragment"><div class="line">VCMD=<span class="stringliteral">&quot;sudo /opt/nec/ve/bin/vecmd -N ?&quot;</span></div>
<div class="line">$VCMD vconfig set partitioning_mode on</div>
<div class="line">$VCMD state set off</div>
<div class="line">$VCMD state set mnt</div>
<div class="line">$VCMD reset card</div>
</div><!-- fragment --><p> VEDA then recognizes each NUMA node as a separate device, i.e. with 2 physical devices in NUMA mode, VEDA would show 4 devices. You can use VEDAresult <a class="el" href="group__vedaapi.html#ga0c9414cf98c4014b283ef54407f5b35e" title="Retrieve the distance of the two given VEDA devices. ">vedaDeviceDistance(float* distance, VEDAdevice devA, VEDAdevice devB)</a> to determine the relationship of two VEDAdevices.</p>
<div class="fragment"><div class="line">distance == 0.0; <span class="comment">// same device</span></div>
<div class="line">distance == 0.5; <span class="comment">// same physical device, different NUMA node</span></div>
<div class="line">distance == 1.0; <span class="comment">// differeny physical device</span></div>
</div><!-- fragment --> <h4>VEDA-smi</h4>
<p>The executable veda-smi displays available VEDA devices in your system. It uses the VEDA_VISIBLE_DEVICES env var and therefore only shows the devices that your VEDA application would be able to use. Use VEDA_VISIBLE_DEVICES= veda-smi to ensure that you see all installed devices.</p>
<div class="fragment"><div class="line">╔ veda-smi ═════════════════════════════════════════════════════════════════════╗</div>
<div class="line">║ VEDA Version: 2.10.0     AVEO Version: 2.8.2                                  ║</div>
<div class="line">╚═══════════════════════════════════════════════════════════════════════════════╝</div>
<div class="line"></div>
<div class="line">┌── #0  NEC SX-Aurora Tsubasa VE10B ────────────────────────────────────────────┐</div>
<div class="line">  ┌ Physical: 1.0</div>
<div class="line">  ├ AVEO:     0.0</div>
<div class="line">  ├ Clock:    current: 1400 MHz, base: 800 MHz, memory: 1600 MHz</div>
<div class="line">  ├ Firmware: 5399</div>
<div class="line">  ├ Memory:   49152 MiB</div>
<div class="line">  ├ Cache:    LLC: 8192kB, L2: 256kB, L1d: 32kB, L1i: 32kB</div>
<div class="line">  ├ Temp:     56.4°C 56.4°C 57.0°C 56.1°C</div>
<div class="line">  └ Power:    18.0W (11.9V, 1.5A)</div>
<div class="line">└───────────────────────────────────────────────────────────────────────────────┘</div>
<div class="line"></div>
<div class="line">┌── #1  NEC SX-Aurora Tsubasa VE10B ────────────────────────────────────────────┐</div>
<div class="line">  ┌ Physical: 1.1</div>
<div class="line">  ├ AVEO:     0.1</div>
<div class="line">  ├ Clock:    current: 1400 MHz, base: 800 MHz, memory: 1600 MHz</div>
<div class="line">  ├ Firmware: 5399</div>
<div class="line">  ├ Memory:   49152 MiB</div>
<div class="line">  ├ Cache:    LLC: 8192kB, L2: 256kB, L1d: 32kB, L1i: 32kB</div>
<div class="line">  ├ Temp:     56.1°C 56.4°C 55.9°C 56.0°C</div>
<div class="line">  └ Power:    18.0W (11.9V, 1.5A)</div>
<div class="line">└───────────────────────────────────────────────────────────────────────────────┘</div>
<div class="line"></div>
<div class="line">┌── #2  NEC SX-Aurora Tsubasa VE10B ────────────────────────────────────────────┐</div>
<div class="line">  ┌ Physical: 0.0</div>
<div class="line">  ├ AVEO:     1.0</div>
<div class="line">  ├ Clock:    current: 1400 MHz, base: 800 MHz, memory: 1600 MHz</div>
<div class="line">  ├ Firmware: 5399</div>
<div class="line">  ├ Memory:   49152 MiB</div>
<div class="line">  ├ Cache:    LLC: 16384kB, L2: 256kB, L1d: 32kB, L1i: 32kB</div>
<div class="line">  ├ Temp:     53.8°C 53.5°C 54.1°C 53.8°C 53.8°C 54.1°C 53.2°C 53.5°C</div>
<div class="line">  └ Power:    36.3W (11.9V, 3.1A)</div>
<div class="line">└───────────────────────────────────────────────────────────────────────────────┘</div>
</div><!-- fragment --> <h4>Environment variables for VEDA</h4>
<table class="doxtable">
<tr>
<th>Environment variables </th><th>Brief </th><th>Default value  </th></tr>
<tr>
<td>VE_LD_LIBRARY_PATH </td><td>Default library path for VE to check for available dynamic and shared libraries of VEDA. </td><td>None </td></tr>
<tr>
<td>VEDA_VISIBLE_DEVICES </td><td>To restrict VEDA to only use those GPUs that have peer-to-peer support. </td><td>0 </td></tr>
</table>
<h4>Environment variables to optimize data transfer</h4>
<p>AVEO(2.7.5 or later) supports the environment variables to optimize the performance of data transfer.</p>
<p>Please refer below link to set AVEO related environment variables, <a href="https://www.hpc.nec/documents/veos/en/aveo/md_GettingStarted.html">https://www.hpc.nec/documents/veos/en/aveo/md_GettingStarted.html</a> </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
